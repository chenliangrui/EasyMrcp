# TCP通信协议

## 1. 概述

本文档描述了EasyMrcp系统中使用的TCP通信协议，用于解决TCP粘包和拆包问题。协议采用了消息头+消息体的格式，其中消息头包含了魔数和消息体长度信息。

## 2. 消息格式

```
+-------------------+------------------------+
| 消息头(8字节)      | 消息体(变长)           |
+-------------------+------------------------+
| 魔数(4字节) | 长度(4字节) | JSON数据        |
+-------------------+------------------------+
```

### 2.1 消息头

消息头总长度为8字节，包含以下字段：

- **魔数**：固定值 `0x66AABB99`，占4字节，用于标识消息的开始和验证消息的有效性
- **消息体长度**：占4字节，表示后续消息体的字节长度（不包括消息头）

### 2.2 消息体

消息体采用JSON格式，长度可变，具体长度由消息头中的长度字段指定。

## 3. 命令消息格式

客户端发送的命令消息格式如下：

```json
{
  "id": "客户端ID",
  "command": "命令类型",
  "data": "命令数据（可选）"
}
```

字段说明：
- `id`: 客户端唯一标识符
- `command`: 命令类型，如 "register", "echo", "speak", "interruptandspeak" 等
- `data`: 命令相关的数据，可以是字符串、数字或对象

## 4. 响应消息格式

服务端返回的命令响应消息格式如下：

```json
{
  "id": "客户端ID",
  "code": 200,
  "message": "响应消息",
  "data": "响应数据（可选）"
}
```

字段说明：
- `id`: 客户端唯一标识符
- `code`: 状态码，200表示成功，500表示错误
- `message`: 响应消息
- `data`: 响应相关的数据，可以是字符串、数字或对象

## 5. 事件消息格式

服务端发送给客户端的事件通知消息格式如下：

```json
{
  "id": "客户端ID",
  "event": "事件类型",
  "data": "事件数据"
}
```

字段说明：
- `id`: 客户端唯一标识符
- `event`: 事件类型，目前支持以下三种事件:
  - `RecognitionComplete` - ASR识别完成事件
  - `SpeakComplete` - TTS合成完成事件
  - `SpeakInterrupt` - TTS合成被打断事件
- `data`: 事件相关的数据，可以是字符串、数字或对象

## 6. 示例

### 6.1 客户端注册命令

```json
{
  "id": "client-001",
  "command": "register",
  "data": null
}
```

### 6.2 服务端注册响应

```json
{
  "id": "client-001",
  "code": 200,
  "message": "Success",
  "data": "连接已注册"
}
```

### 6.3 客户端发送文本转语音命令

```json
{
  "id": "client-001",
  "command": "speak",
  "data": "你好，这是一段测试文本"
}
```

### 6.4 服务端ASR识别完成事件通知

```json
{
  "id": "client-001",
  "event": "RecognitionComplete",
  "data": "识别到的文本内容"
}
```

### 6.5 服务端TTS合成完成事件通知

```json
{
  "id": "client-001",
  "event": "SpeakComplete",
  "data": "completed"
}
```

### 6.6 服务端TTS合成被打断事件通知

```json
{
  "id": "client-001",
  "event": "SpeakInterrupt",
  "data": "interrupted"
}
```

## 7. 注意事项

1. 所有消息都必须按照指定格式封装，包含消息头和消息体
2. 客户端和服务端必须能够正确处理粘包和拆包情况
3. 在处理过程中，应该验证魔数的正确性，以确保消息的有效性
4. 消息体的长度必须与消息头中指定的长度一致
5. JSON数据应使用UTF-8编码

## 8. 错误处理

当接收到错误的消息格式或无法解析的消息时，接收方应：

1. 尝试查找下一个魔数位置
2. 丢弃无效数据
3. 从有效的魔数位置继续解析

当命令处理失败时，服务端会返回一个错误响应，格式如下：

```json
{
  "id": "客户端ID",
  "code": 500,
  "message": "错误描述",
  "data": null
}
``` 